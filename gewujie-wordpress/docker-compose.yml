version: '3.8'

services:
  # WordPress 主服务
  gewujie-wordpress:
    image: wordpress:6.9.0-php8.2-apache
    container_name: gewujie-wordpress
    restart: unless-stopped
    ports:
      - "${WORDPRESS_PORT}:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_USER: gewujie_user
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
      WORDPRESS_DB_NAME: gewujie_wp_db
    volumes:
      - ./gewujie-wordpress:/var/www/html
      - ./uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
      - ./custom-php.ini:/usr/local/etc/php/conf.d/custom-php.ini
    depends_on:
      gewujie-db:
        condition: service_healthy
    networks:
      - gewujie-network
    labels:
      - "caddy=localhost"
      - "caddy.reverse_proxy={{upstreams 80}}"

  # MySQL 数据库服务
  gewujie-db:
    image: mysql:8.4.7
    container_name: gewujie-db
    restart: unless-stopped
    ports:
      - "${MYSQL_PORT}:3306"
    environment:
      MYSQL_DATABASE: gewujie_wp_db
      MYSQL_USER: gewujie_user
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
      TZ: Asia/Shanghai
      SET_CONTAINER_TIMEZONE: true
      CONTAINER_TIMEZONE: Asia/Shanghai
    volumes:
      - ./gewujie-db-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    networks:
      - gewujie-network
    command:
#      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --bind-address=0.0.0.0
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      timeout: 20s
      retries: 10
      start_period: 30s
      interval: 10s

  # phpMyAdmin 服务
  gewujie-phpmyadmin:
    image: phpmyadmin/phpmyadmin:5.2.3
    container_name: gewujie-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: gewujie-db
      PMA_PORT: 3306
      UPLOAD_LIMIT: 64M
      MEMORY_LIMIT: 256M
      MAX_EXECUTION_TIME: 300
    depends_on:
      gewujie-db:
        condition: service_healthy
    networks:
      - gewujie-network
    labels:
      - "caddy=phpmyadmin.localhost"
      - "caddy.reverse_proxy={{upstreams 80}}"

  # Redis 缓存服务
  gewujie-redis:
    image: redis:7-alpine
    container_name: gewujie-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./gewujie-redis-data:/data
    networks:
      - gewujie-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Caddy 反向代理
  gewujie-caddy:
    image: caddy:2.11
    container_name: gewujie-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      CADDY_DOCKER_PROXY_SERVICE_NETWORK: gewujie-wp-network
    volumes:
      - ./gewujie-caddy-data:/data
      - ./gewujie-caddy-config:/config
      - ./Caddyfile:/etc/caddy/Caddyfile
    networks:
      - gewujie-network
    depends_on:
      - gewujie-wordpress
      - gewujie-phpmyadmin

networks:
  gewujie-network:
    driver: bridge
    name: gewujie-wp-network
